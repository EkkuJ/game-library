<!DOCTYPE html>
<html>

<head>
	<title>Free Falling</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<link rel="stylesheet" type="text/css" href="">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
</head>

<body>
	<div class="container">
		<header>
			<h1>Free Falling</h1>
		</header>
		<div id="instruction">Type the letter before time runs out</div>
		<div class="gameScreen">
			<div id="letter">#</div>
			<div class="sidebar">
				<div id="gameStats">
					<h3>Score: <span id='typedScore'>0</span><span> / </span><span id='targetScore'>1</span></h3>
					<h3>Time: <span id="time">10</span></h3>
					<input type="button" value="Start" id="startBut">
				</div>
				<div class="submit">
					<div>
						<input type="button" value="Submit score" id="submitBut">
					</div>
					<div>
						<input type="button" value="Save Game" id="saveBut">
					</div>
					<div>
						<input type="button" value="Load Game" id="loadBut">
					</div>
				</div>
			</div>
		</div>
	</div>
	<script type="text/javascript">

		var let_id = document.getElementById("letter");
		var start_id = document.getElementById("startBut");
		var typedScore_id = document.getElementById("typedScore");
		var targetScore_id = document.getElementById("targetScore");
		var time_id = document.getElementById("time");
		var submitScore_id = document.getElementById("submitBut");
		var saveGame_id = document.getElementById("saveBut");
		var loadGame_id = document.getElementById("loadBut");

		var typedScore = 0;
		var targetScore = 1;
		var playingGame = false;
		var time = 10;
		var x;

		var characters = [
			["a", 65],
			["b", 66],
			["c", 67],
			["d", 68],
			["e", 69],
			["f", 70],
			["g", 71]
		];

		// decrease the time every second, a player has 10 seconds in total
		function timer() { 
			x = setInterval(() => {
				time -= 1;
				time_id.innerHTML = time;
				if (time <= 0) end();
			}, 1000);
		};

		// starts the game
		start_id.addEventListener("click", function () {
			if (!playingGame) {
				playingGame = true;
				newLetter();
				timer();
			};
		});

		// changes letter
		function newLetter() {
			this.targetIndex = Math.floor(Math.random() * characters.length);
			let_id.innerHTML = characters[this.targetIndex][0];
		};

		// changes letter and adds score when correctly presses a button
		document.addEventListener("keydown", event => {
			if (playingGame && event.keyCode === characters[targetIndex][1]) {
				typedScore += 1;
				typedScore_id.innerHTML = this.typedScore;
				if (typedScore == targetScore) {
					end(true);
				} else newLetter();
			};
		});

		// if the player runs out of time or clears the level, the game ends
		function end(finished) {
			playingGame = false;
			clearInterval(x);
			let_id.innerHTML = "#";
			time = 10;
			time_id.innerHTML = time;
			typedScore = 0;
			typedScore_id.innerHTML = typedScore;
			if (finished) {
				targetScore += 2;
				targetScore_id.innerHTML = targetScore;
				window.alert("Great!")

			} else window.alert("Try again!")
		};

		submitScore_id.addEventListener("click", function () {
			if (!playingGame) {
				var msg = {
					"messageType": "SCORE",
					"score": parseFloat(targetScore_id.innerHTML)
				};
				window.parent.postMessage(msg, "*");

			};
		});

		saveGame_id.addEventListener("click", function () {

			if (!playingGame) {
				var msg = {
					"messageType": "SAVE",
					"gameState": {
						"score": parseFloat(targetScore_id.innerHTML)
					}
				};
				window.parent.postMessage(msg, "*");
			}

		});

		loadGame_id.addEventListener("click", function () {

			if (!playingGame) {
				var msg = {
					"messageType": "LOAD_REQUEST",
				};
				window.parent.postMessage(msg, "*");
			};

		});

		window.addEventListener("message", function (evt) {

			if (evt.data.messageType === "LOAD" && !playingGame) {
				targetScore = evt.data.gameState.score;
				targetScore_id.innerHTML = targetScore;

			} else if (evt.data.messageType === "ERROR") {

				alert(evt.data.info);
			};
		});

		var message = {
			messageType: "SETTING",
			options: {
				"width": 550, //Integer
				"height": 380 //Integer
			}
		};

		window.parent.postMessage(message, "*");

	</script>
</body>

</html>