{% extends 'base.html' %}

{% block content %}
<div class="hero-unit" id="content" style="padding-top: 30px;" >
    <div class="gameView">
        <div class="page-header">
            <h1>{{ game.nameÂ }}</h1>
        </div>
        <p>{{ game.description }}</p>
        <iframe id="myFrame" src={{ game.url }}>
        </iframe>
        <div class="media-body" style="padding-top: 20px;">
            <div class="media-body" style="padding-left: 10px; padding-top: 15px; background-color: lightgray; border-radius: 10px;">
                <h3 class="mt-0">Highscores</h3>
                {% if owned_game_objects %}
                {% for owned_game in owned_game_objects %}
                <span class="card-body">
                    <h6>{{ owned_game.player.username }}
                        <span class="badge badge-secondary">{{ owned_game.highscore }}
                        </span></h6>
                </span>
                {% endfor %}
                {% else %}
                <p>No scores yet</p>
                {% endif %}
            </div>
        </div>
        <!-- Facebook-share button -->
        <div>
            <div class="fb-share-button" data-href="https://game-x-changers.herokuapp.com/preview/0" data-layout="button" data-size="large"><a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fgame-x-changers.herokuapp.com%2Fpreview%2F1&amp;src=sdkpreparse" class="fb-xfbml-parse-ignore">Share</a></div>
        </div>
    </div>
</div>

<div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v6.0&appId=284918521754"></script>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script>
    var myFrame = document.getElementById('myFrame').contentWindow;
    window.onmessage = function (event) {
        var message = event.data;
        if (message.messageType == "SETTING") {

            var width = message.options.width.toString().concat("px");
            var height = message.options.height.toString().concat("px");
            $("#myFrame")[0].style.width = width;
            $("#myFrame")[0].style.height = height;

        } else if (message.messageType == "SCORE") {
            console.log(message.score);

            $.ajax({
                type: 'POST',
                url: '/playGame/{{ game.id }}',
                data: {
                    'csrfmiddlewaretoken': "{{  csrf_token  }}",
                    score: message.score
                },
                success: function () {
                    // refresh the page when a new highscore is submitted
                    location.reload()
                 }
            });

        } else if (message.messageType == "SAVE") {
            $.ajax({
                type: 'POST',
                url: '/playGame/{{ game.id }}',
                data: {
                    'csrfmiddlewaretoken': "{{  csrf_token  }}",
                    state: JSON.stringify(message.gameState)
                },
                success: function () { }
            });

        } else if (message.messageType == "LOAD_REQUEST") {


            $.ajax({
                type: 'POST',
                url: '/playGame/{{ game.id }}',
                data: {
                    'csrfmiddlewaretoken': "{{  csrf_token  }}",
                    getProgress: ""
                },
                success: function (result) {
                    var res = JSON.parse(JSON.parse(result));
                    var loadMessage = {
                        "messageType": "LOAD",
                        "gameState": res
                    };
                    myFrame.postMessage(loadMessage, "*");
                }
            })
        };

    };

</script>

{% endblock %}